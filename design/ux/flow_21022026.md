# flow.md â€” BreakLoop Implemented Runtime Flow

> **This document reflects the actual code as of 2026-02-21.**  
> It is derived from source files, not from design specs.  
> Where the implementation diverges from `flow_Native_V4.md`, that is noted explicitly.

---

## Architecture Overview

The app runs in two mutually exclusive React roots, determined by `RuntimeContextProvider`:

| Root | Activity | Responsibility |
|------|----------|----------------|
| `MainAppRoot` | `MainActivity` | Main app UI (tabs, settings, Alternatives browsing) |
| `SystemSurfaceRoot` | `SystemSurfaceActivity` | All system-triggered overlays (intervention, Quick Task) |

The two roots never render simultaneously. `SystemSurfaceActivity` is a full-screen overlay launched by native (`AppMonitorModule`).

**Authority split (Phase 4.2, current):**
- **Native** is authoritative for Quick Task state machine (entry decisions, quota, timers).
- **JS** handles intervention flow, post-QT choice UI, and intention timer state.

---

## 0) Scope & Invariants

### Applies to
Apps the user has configured as **Monitored** (stored in `AsyncStorage` under `monitored_apps_v1`).

### Per-app scope
The following are scoped per monitored app:
- `intentionTimers[app]` â€” persisted in System Brain state (`system_brain_state_v1`)
- Quick Task timers + quota â€” managed by **Native** (not in JS state)

### Hard Break
> **âš ï¸ NOT IMPLEMENTED.** `flow_Native_V4.md Â§6` describes Hard Break (Reset Break). There are no screens, reducers, or native handlers for it in the current codebase.

### Foreground-gated expiry
Intention timer expiry is captured at `TIMER_EXPIRED` time (time-of-truth pattern). The expiry only triggers UI when the user next interacts with the app (via a foreground event while the target app is foreground).

---

## 1) Decision Gate on Monitored App Entry

**Trigger:** Native (`ForegroundDetectionService`) detects a monitored app entering foreground. Native emits a Quick Task decision event to JS via `handleQuickTaskCommand()`.

**Native decision priority (in native layer):**
1. `SystemSurface` already active? â†’ suppress (no duplicate launch).
2. Quick Task timer active (ACTIVE phase)? â†’ suppress.
3. Quick Task quota > 0? â†’ emit `SHOW_QUICK_TASK_DIALOG`.
4. Otherwise â†’ emit `NO_QUICK_TASK_AVAILABLE` â†’ JS launches Intervention.

**JS handling (`eventHandler.ts` â†’ `handleQuickTaskCommand()`):**

| Native command | JS action |
|---|---|
| `SHOW_QUICK_TASK_DIALOG` | `launchSystemSurface(app, 'SHOW_QUICK_TASK_DIALOG')` |
| `NO_QUICK_TASK_AVAILABLE` | `launchSystemSurface(app, 'START_INTERVENTION_FLOW')` |
| `SHOW_INTERVENTION` | `launchSystemSurface(app, 'START_INTERVENTION_FLOW')` |
| `SHOW_POST_QUICK_TASK_CHOICE` | `launchSystemSurface(app, 'POST_QUICK_TASK_CHOICE')` |
| `START_QUICK_TASK_ACTIVE` | (no-op in JS; ACTIVE phase is silent) |
| `FINISH_SYSTEM_SURFACE` | Calls `AppMonitorModule.finishSystemSurfaceActivity()` |

> **Divergence from V4:** V4 defines an intention-timer suppressor check inside JS `evaluateOSTriggerBrain()`. In the current code (Phase 4.2), foreground entry decisions are made entirely by **native**; the JS `evaluateOSTriggerBrain()` is still present in `decisionEngine.ts` but is **not called for foreground entry events**. Intention timer suppression now uses a native `setSuppressSystemSurfaceUntil()` flag.

> **Divergence from V4:** V4 Â§1 describes a "Hard Break active?" priority. This check is **not present** in the current codebase.

---

## 2) Quick Task Lane

### 2.1 Quick Task Dialog (`QuickTaskDialogScreen`)
Shown when native decides `SHOW_QUICK_TASK_DIALOG`. Session kind: `QUICK_TASK`.

User actions:
- **"Start conscious process"** (primary) â†’ `AppMonitorModule.quickTaskSwitchToIntervention(app)` â†’ `REPLACE_SESSION` to start `INTERVENTION`.
- **"Quick Task"** (secondary) â†’ `AppMonitorModule.quickTaskConfirm(app, sessionId)` â†’ native transitions OFFERING â†’ ACTIVE â†’ JS calls `safeEndSession(false)` (silent, no UI, user returns to app).
- **âœ• (close)** â†’ `AppMonitorModule.quickTaskDecline(app)` â†’ `safeEndSession(true)` (launch home).

Displays: remaining quota count and reset time (loaded via `getQuickTaskRemainingForDisplay()`).

### 2.2 Quick Task ACTIVE Phase
After confirming Quick Task:
- No JS UI. Native enforces the timer silently.
- When timer expires in foreground, native emits `SHOW_POST_QUICK_TASK_CHOICE`.

### 2.3 Post-Quick-Task Choice (`PostQuickTaskChoiceScreen`)
Shown when native emits `SHOW_POST_QUICK_TASK_CHOICE`. Session kind: `POST_QUICK_TASK_CHOICE`.

User actions:
- **"Close {App}"** (primary) â†’ `AppMonitorModule.quickTaskPostQuit(app, sessionId)` â†’ `safeEndSession(true)` (launch home).
- **"I want to use '{App}' more"** (secondary) â†’ `AppMonitorModule.quickTaskPostContinue(app, sessionId)` â†’ `safeEndSession(false)` (return to app; no intention timer set).

Back button: treated as "Quit".

> **Divergence from V4 Â§2.3:** V4 says "I want to use {App} more â†’ dismiss dialog and return to app (no intention timer)". Implementation matches this exactly.

---

## 3) Intervention Lane

### 3.1 Entry â€” Breathing (`BreathingScreen`)

Started when `BEGIN_INTERVENTION` is dispatched by `InterventionFlow`. Duration comes from `getInterventionDurationSec()` (from `osConfig`).

Breathing animation: pulsing blue circle (4s inhale / 4s exhale loop), "Breathe in" / "Breathe out" text with fade transitions.

The buttons appear only **after** the breathing timer reaches 0 (`breathingCompleted = true`).

Actions (revealed after timer):
- **"Close app"** â†’ `RESET_INTERVENTION` (reason: `USER_CLOSE`) â†’ `safeEndSession(true)` (launch home).
- **"Continue to use app"** â†’ `BREATHING_COMPLETE` â†’ transition to `root-cause` state.

Back button: blocked during breathing.

### 3.2 Root Cause (`RootCauseScreen`)

State: `root-cause`.

Prompt: "What's driving this urge?"

Six causes (multi-select, 2-column grid):
- Boredom Â· Anxiety Â· Fatigue Â· Loneliness Â· Self-doubt Â· No clear goal

Actions:
- **"See alternatives"** (enabled only when â‰¥1 cause selected) â†’ `PROCEED_TO_ALTERNATIVES`.
- **"I really need to use it"** (de-emphasized text link, always available) â†’ `PROCEED_TO_TIMER` â†’ `IntentionTimerScreen`.
- **âœ• (close)** â†’ `RESET_INTERVENTION` â†’ `safeEndSession(true)` (launch home).

Back button: blocked.

> **Divergence from V4:** V4 Â§3 describes a "Fast Lane Entry" / Purpose Picker flow for returning users of "manipulated/feed apps". This is **not implemented**. `RootCauseScreen` is always shown for all apps; there is no Purpose concept in the current codebase.

### 3.3 Alternatives (`AlternativesScreen`)

State: `alternatives`. 

Three tabs:
- **Discover** (default): Activities filtered by selected causes from `alternativesDatabase` + context filter (night time). Popularity data loaded from `popularityService`. Activities already saved are excluded. Each card: title, duration, description, "Save" button, popularity count ("ğŸ”¥ N likes").
- **AI For You**: Static placeholder suggestions (not real AI). Cards with "âœ¨ AI Suggestion" badge.
- **My List**: User's saved activities. Supports delete (ğŸ—‘ï¸). Shows "Add your own idea" and "Get inspired by AI" actions (not fully functional, dispatch stub actions).

Actions:
- **Tapping any card** â†’ `SELECT_ALTERNATIVE` + `PROCEED_TO_ACTION` â†’ navigate to `ActionConfirmationScreen`.
- **"Ignore & Continue"** â†’ `PROCEED_TO_TIMER` â†’ `IntentionTimerScreen`.
- **Back / swipe back** â†’ `GO_BACK_TO_ROOT_CAUSE` â†’ back to `RootCauseScreen`.

> **Divergence from V4 Â§5:** V4 describes a "Support ladder" (Trigger picker â†’ Micro-WHY â†’ Alternatives deep link). The current implementation **integrates Alternatives directly** into the intervention flow as step 3 (after root cause). There is no separate Trigger picker or Micro-WHY screen. Instead, the "root cause" step serves a similar purpose (cause selection), and Alternatives are browsed immediately after.

> **Divergence from V4 Â§5.3:** V4 describes "Continue using inside support ladder â†’ opens Set Intention". In the current implementation, "Ignore & Continue" on `AlternativesScreen` goes to `IntentionTimerScreen`.

### 3.4 Action Confirmation (`ActionConfirmationScreen`)

State: `action`.

Shows the selected alternative's details. User confirms they want to do the activity.

Actions:
- **Confirm / proceed** â†’ `START_ALTERNATIVE` â†’ `action_timer` state â†’ `START_ALTERNATIVE_ACTIVITY` session event.
- **Back** â†’ `GO_BACK_FROM_ACTION` â†’ back to `alternatives`.

### 3.5 Alternative Activity Timer (`ActivityTimerScreen`)

State: `action_timer`. Session kind: `ALTERNATIVE_ACTIVITY`.

Countdown timer for the selected activity. Timer is time-based (snapshot stored in `AsyncStorage` as `intervention_snapshot_{app}`). The snapshot allows resumability across app switches.

Actions:
- **Finish early** â†’ `FINISH_ACTION` â†’ `reflection` state.
- Timer reaching 0 â†’ `ACTION_TIMER_COMPLETE` â†’ `reflection` state.

Snapshot lifecycle:
- On entering `action_timer`: `setInterventionPreserved(targetApp, true)` + save snapshot.
- On exiting `action_timer`: `setInterventionPreserved(targetApp, false)` + remove snapshot.

### 3.6 Reflection (`ReflectionScreen`)

State: `reflection`.

Post-activity reflection UI.

Action:
- **Finish** â†’ `FINISH_REFLECTION` â†’ `idle` state â†’ `safeEndSession(true)` (launch home).

### 3.7 Intention Timer (`IntentionTimerScreen`)

State: `timer`. Reachable from `RootCauseScreen` ("I really need to use it") or `AlternativesScreen` ("Ignore & Continue").

Title: **"Set Intention Timer"** (ğŸ• icon).

Duration options: **5m Â· 15m Â· 30m Â· 45m Â· 60m** (grid of cards).

Also has a **"Just 1 min"** text link.

On selection:
1. `setIntentionTimer(app, durationMs, timestamp)` (JS state).
2. `AppMonitorModule.setSuppressSystemSurfaceUntil(app, expiresAt)` (native suppressor).
3. `AppMonitorModule.storeIntentionTimer(app, expiresAt)` (native SharedPreferences).
4. `setTransientTargetApp(app)`.
5. `SET_INTENTION_TIMER` â†’ `idle` state.
6. `safeEndSession(false)` â†’ return to app (not home).

Back button: blocked.

> **Divergence from V4 Â§3.2:** V4 specifies intention timer presets of **1 / 5 / 15 / 30 / 45** min with progressive disabling based on `checkpointCount`. The current implementation offers **5 / 15 / 30 / 45 / 60** min (no 1m preset, no progressive disabling, no checkpoint count), plus a separate "Just 1 min" text link. There is no `checkpointCount` concept in the current codebase.

---

## 4) Checkpoint Ladder

> **âš ï¸ NOT IMPLEMENTED.** `flow_Native_V4.md Â§3.4`, `Â§4`, and `Â§5` describe a checkpoint system where `t_intention` expiry increments `checkpointCount` and surfaces progressively firmer checkpoints (CP1 â†’ CP2 â†’ CP3 â†’ CP4 warning â†’ CP5 Hard Break).  
>  
> In the current implementation:
> - There is **no `checkpointCount`** tracking.
> - When an intention timer expires and the user re-opens the monitored app, the **Decision Gate runs fresh** (same flow from the top: Quick Task dialog or full Intervention).
> - There is **no escalating checkpoint UI** (no CP1/CP2/CP3 screens, no "I'm stuck â€” help me", no Hard Break warning).
> - There is **no progressive disabling of timer durations**.

---

## 5) Session Flow Summary

```
Native detects monitored app foreground
         â”‚
         â–¼
 [Native Quick Task decision]
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ quota > 0                             â”‚ quota = 0
    â–¼                                       â–¼
QuickTaskDialogScreen              Breathing (intervention starts)
    â”‚                                       â”‚
    â”œâ”€ "Start conscious process" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                                       â–¼
    â”‚                               RootCauseScreen
    â”‚                                       â”‚
    â”‚                               AlternativesScreen
    â”‚                                       â”‚
    â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚                           â”‚
    â”‚                 Card tap                   "Ignore & Continue"
    â”‚                         â”‚                           â”‚
    â”‚                 ActionConfirmationScreen    IntentionTimerScreen
    â”‚                         â”‚                           â”‚
    â”‚                 ActivityTimerScreen         SET_INTENTION â†’ idle
    â”‚                         â”‚                  â†’ return to app
    â”‚                 ReflectionScreen
    â”‚                         â”‚
    â”‚                      idle â†’ safeEndSession(launch home)
    â”‚
    â”œâ”€ "Quick Task" â”€â”€â–º ACTIVE (silent, no UI)
    â”‚                   timer expires â†’ POST_QUICK_TASK_CHOICE
    â”‚
    â””â”€ "âœ• Close" â”€â”€â”€â”€ safeEndSession(launch home)
```

---

## 6) State Machine States (Intervention)

Defined in `src/core/intervention/state.js` and managed by `interventionReducer` in `transitions.js`:

| State | Description |
|-------|-------------|
| `idle` | No intervention active |
| `breathing` | Breathing countdown screen |
| `root-cause` | Cause selection |
| `alternatives` | Alternatives browsing (Discover / AI For You / My List) |
| `action` | Action confirmation (selected activity details) |
| `action_timer` | Activity timer running (alternative in progress) |
| `timer` | Intention timer selection screen |
| `reflection` | Post-activity reflection |

---

## 7) System Session Kinds

Defined in `SystemSessionProvider.tsx`:

| Session kind | Screen rendered |
|---|---|
| `INTERVENTION` | `InterventionFlow` (breathing â†’ cause â†’ alternatives â†’ ...) |
| `QUICK_TASK` | `QuickTaskDialogScreen` |
| `POST_QUICK_TASK_CHOICE` | `PostQuickTaskChoiceScreen` |
| `ALTERNATIVE_ACTIVITY` | `AlternativeActivityFlow` (ActivityTimerScreen + ReflectionScreen) |
| `null` | No overlay (SystemSurface finishes) |

---

## 8) Screen Inventory (Implemented)

### SystemSurface (overlay) screens
- `BreathingScreen` â€” breathing countdown
- `RootCauseScreen` â€” cause selection
- `AlternativesScreen` â€” browse alternatives (Discover / AI For You / My List tabs)
- `ActionConfirmationScreen` â€” selected activity confirmation
- `ActivityTimerScreen` â€” alternative activity countdown timer
- `ReflectionScreen` â€” post-activity reflection
- `IntentionTimerScreen` â€” select intention duration
- `QuickTaskDialogScreen` â€” Quick Task offering
- `PostQuickTaskChoiceScreen` â€” post-QT expiry choice

### Main App (tab) screens
- `MainAppRoot` â€” tab navigation (Home/Insights, Alternatives, Settings)
- `InsightsScreen` â€” usage insights
- `AlternativesTabHost` â†’ `DiscoverScreen` + `MyListScreen` â€” Alternatives main-app tab
- `SettingsScreen` â€” app settings (Quick Task config, monitored apps)
- `EditMonitoredAppsScreen` â€” add/remove monitored apps

---

## 9) Key Missing Features (Specified in V4, Not Implemented)

| V4 feature | Status |
|---|---|
| Checkpoint ladder (CP1â€“CP5) | âŒ Not implemented |
| `checkpointCount` tracking | âŒ Not implemented |
| Progressive timer disabling | âŒ Not implemented |
| Hard Break / Reset Break | âŒ Not implemented |
| Emergency unlock (face-down / week override / emergency pass) | âŒ Not implemented |
| Fast Lane Entry (returning users, purpose display) | âŒ Not implemented |
| Purpose Picker (F3) | âŒ Not implemented |
| `lastPurpose` / `recentPurposes` persistence | âŒ Not implemented |
| Trigger picker (Support ladder S1) | âŒ Not implemented |
| Micro-WHY screen (Support ladder S2) | âŒ Not implemented |
| "I'm stuck â€” help me" button on CP screens | âŒ Not implemented |
| Alternatives deep-link from Support ladder | âŒ Not implemented (Alternatives is in-flow, not deep-linked) |
| Timer presets 1m / 5m / 15m / 30m / 45m (V4 set) | âŒ Has 5/15/30/45/60 instead + "Just 1 min" link |
