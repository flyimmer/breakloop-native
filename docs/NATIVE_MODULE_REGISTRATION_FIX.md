# Native Module Registration Fix

## Problem: AppMonitorModule Not Available

### What Happened

The "Enable Accessibility Service" button in Settings was not working because `NativeModules.AppMonitorModule` was `undefined`. 

**Root Cause:** The `AppMonitorPackage` was **never registered** in `MainApplication.kt`, so React Native didn't know about our native module.

### Why It Happened

The Expo config plugin (`plugins/withForegroundService.js`) was doing these things:

✅ Copying `AppMonitorModule.kt` to `android/app/src/main/`  
✅ Copying `AppMonitorPackage.kt` to `android/app/src/main/`  
✅ Registering services in `AndroidManifest.xml`  
✅ Copying XML resources  

❌ **BUT NOT** registering `AppMonitorPackage` in `MainApplication.kt`

### The Missing Step

In React Native, native modules must be **explicitly registered** in `MainApplication.kt`:

```kotlin
override fun getPackages(): List<ReactPackage> =
    PackageList(this).packages.apply {
      // This line was missing:
      add(AppMonitorPackage())
    }
```

Without this registration:
- React Native doesn't load the module
- `NativeModules.AppMonitorModule` is `undefined`
- All native methods fail silently
- JavaScript sees no error until it tries to call a method

## The Fix

### 1. Updated the Plugin

Added `registerAppMonitorPackage()` function to `plugins/withForegroundService.js`:

```javascript
/**
 * Modify MainApplication.kt to register AppMonitorPackage
 */
function registerAppMonitorPackage(projectRoot) {
  const mainApplicationPath = path.join(
    projectRoot,
    'android',
    'app',
    'src',
    'main',
    'java',
    'com',
    'anonymous',
    'breakloopnative',
    'MainApplication.kt'
  );
  
  // ... validation ...
  
  // Find the closing brace of the apply block and add the package before it
  const applyBlockPattern = /(PackageList\(this\)\.packages\.apply\s*\{[\s\S]*?)(            \})/;
  
  if (applyBlockPattern.test(content)) {
    content = content.replace(
      applyBlockPattern,
      '$1              add(AppMonitorPackage())\n$2'
    );
    
    fs.writeFileSync(mainApplicationPath, content);
    console.log(`[${PLUGIN_NAME}] ✅ Registered AppMonitorPackage in MainApplication.kt`);
  }
}
```

### 2. Called in Plugin Lifecycle

```javascript
const withForegroundService = (config) => {
  config = withDangerousMod(config, [
    'android',
    async (config) => {
      const projectRoot = config.modRequest.projectRoot;
      
      copyKotlinFiles(projectRoot);
      copyAccessibilityXml(projectRoot);
      
      // NEW: Register the package
      registerAppMonitorPackage(projectRoot);
      
      return config;
    },
  ]);
  
  // ... other modifications ...
  
  return config;
};
```

### 3. Verification

After running `npx expo prebuild`, the plugin now logs:

```
[withForegroundService] ✅ Registered AppMonitorPackage in MainApplication.kt
```

And `MainApplication.kt` contains:

```kotlin
override fun getPackages(): List<ReactPackage> =
    PackageList(this).packages.apply {
      // Packages that cannot be autolinked yet can be added manually here, for example:
      // add(MyReactNativePackage())
      add(AppMonitorPackage())  // ✅ Now registered!
    }
```

## Why This Error Was Hard to Catch

### 1. **Silent Failure**
- No error when the app starts
- No error when Settings screen loads
- Only fails when button is pressed
- Error message is generic: "module not available"

### 2. **Worked in Some Contexts**
- Other parts of the app might not use the native module
- Easy to miss during development
- Only caught when testing specific features

### 3. **Plugin Complexity**
- Expo config plugins have many steps
- Easy to forget one registration step
- No built-in validation that modules are registered

### 4. **Auto-Generated Files**
- `android/` folder is regenerated by `expo prebuild`
- Manual fixes get lost on next prebuild
- Must fix the plugin, not the generated files

## Prevention Strategies

### 1. ✅ Plugin Self-Validation

Add validation to the plugin that checks if registration succeeded:

```javascript
function registerAppMonitorPackage(projectRoot) {
  // ... registration code ...
  
  // Verify it worked
  const updatedContent = fs.readFileSync(mainApplicationPath, 'utf-8');
  if (!updatedContent.includes('add(AppMonitorPackage())')) {
    throw new Error(
      `[${PLUGIN_NAME}] CRITICAL: Failed to register AppMonitorPackage in MainApplication.kt. ` +
      `Please manually add: add(AppMonitorPackage()) to getPackages() method.`
    );
  }
}
```

**Status:** ✅ Can be added to the plugin

### 2. ✅ Build-Time Validation Script

Create `scripts/validate-native-modules.js`:

```javascript
const fs = require('fs');
const path = require('path');

const mainApplicationPath = path.join(
  __dirname,
  '..',
  'android',
  'app',
  'src',
  'main',
  'java',
  'com',
  'anonymous',
  'breakloopnative',
  'MainApplication.kt'
);

if (!fs.existsSync(mainApplicationPath)) {
  console.error('❌ MainApplication.kt not found. Run `npx expo prebuild` first.');
  process.exit(1);
}

const content = fs.readFileSync(mainApplicationPath, 'utf-8');

const requiredPackages = [
  'AppMonitorPackage()',
];

let allRegistered = true;

requiredPackages.forEach(pkg => {
  if (!content.includes(`add(${pkg})`)) {
    console.error(`❌ Missing native module registration: ${pkg}`);
    allRegistered = false;
  } else {
    console.log(`✅ ${pkg} is registered`);
  }
});

if (!allRegistered) {
  console.error('\n❌ Native module validation failed!');
  console.error('Run `npx expo prebuild` to regenerate native files.');
  process.exit(1);
}

console.log('\n✅ All native modules are properly registered!');
```

Add to `package.json`:

```json
{
  "scripts": {
    "validate:native": "node scripts/validate-native-modules.js",
    "android": "npm run sync:kotlin && npm run validate:native && npx expo run:android"
  }
}
```

**Status:** ✅ Can be implemented immediately

### 3. ✅ TypeScript Module Check

Add a startup check in `app/App.tsx`:

```typescript
useEffect(() => {
  if (Platform.OS === 'android') {
    if (!NativeModules.AppMonitorModule) {
      console.error('❌ CRITICAL: AppMonitorModule not registered!');
      console.error('This will cause native features to fail.');
      console.error('Run: npx expo prebuild --clean');
      
      if (__DEV__) {
        Alert.alert(
          'Native Module Error',
          'AppMonitorModule is not registered. Please rebuild the app with: npx expo prebuild --clean && npm run android',
          [{ text: 'OK' }]
        );
      }
    } else {
      console.log('✅ AppMonitorModule is available');
    }
  }
}, []);
```

**Status:** ✅ Can be added to App.tsx

### 4. ✅ Documentation

Create clear documentation about:
- How native modules are registered
- What the plugin does
- How to verify registration
- Troubleshooting steps

**Status:** ✅ This document!

### 5. ✅ CI/CD Checks

Add to CI pipeline:

```yaml
- name: Validate Native Modules
  run: |
    npm run validate:native
```

**Status:** ✅ Can be added when CI is set up

## Testing the Fix

### 1. Clean Rebuild

```bash
npx expo prebuild --clean
npm run android
```

### 2. Check Logs

Look for:
```
[withForegroundService] ✅ Registered AppMonitorPackage in MainApplication.kt
```

### 3. Test in App

1. Open Settings
2. Press "Enable Accessibility Service" button
3. Should open Android Accessibility Settings
4. No error about "module not available"

### 4. Verify in Code

```bash
grep -n "add(AppMonitorPackage())" android/app/src/main/java/com/anonymous/breakloopnative/MainApplication.kt
```

Should show the line where it's registered.

## Lessons Learned

### 1. **Plugin Completeness**
When creating an Expo config plugin for native modules:
- ✅ Copy Kotlin files
- ✅ Copy resources (XML, etc.)
- ✅ Modify AndroidManifest.xml
- ✅ **Register the package in MainApplication.kt** ← We missed this!

### 2. **Validation is Critical**
- Don't assume the plugin worked
- Add validation checks
- Fail loudly if something is wrong
- Provide clear error messages

### 3. **Test Native Features Early**
- Test native module availability on app startup
- Don't wait until a feature is used
- Add dev-mode alerts for missing modules

### 4. **Document the Architecture**
- Explain how native modules work
- Document the plugin's responsibilities
- Provide troubleshooting guides
- Make it easy for future developers

## Related Files

- `plugins/withForegroundService.js` - Expo config plugin (SOURCE OF TRUTH)
- `android/app/src/main/java/com/anonymous/breakloopnative/MainApplication.kt` - Auto-generated
- `plugins/src/android/java/com/anonymous/breakloopnative/AppMonitorPackage.kt` - Package definition
- `plugins/src/android/java/com/anonymous/breakloopnative/AppMonitorModule.kt` - Native module
- `src/native-modules/AppMonitorModule.ts` - TypeScript interface
- `app/screens/mainAPP/Settings/SettingsScreen.tsx` - Where the error was discovered

## Summary

**Problem:** Native module not registered → `NativeModules.AppMonitorModule` undefined  
**Cause:** Plugin didn't modify `MainApplication.kt`  
**Fix:** Added `registerAppMonitorPackage()` to plugin  
**Prevention:** Validation scripts + startup checks + documentation  

**Status:** ✅ Fixed and validated
